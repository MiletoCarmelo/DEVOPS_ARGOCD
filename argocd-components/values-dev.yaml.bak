module: argocd

projects:
  - name: infrastructure  # Ajout du projet infrastructure
  - name: quant-cm

cert-manager:
  enabled: true
  version: v1.16.1
  url: https://charts.jetstack.io

sealed-secrets:
  enabled: true
  version: 0.27.2
  url: https://bitnami-labs.github.io/sealed-secrets

ingress-nginx:
  enabled: true
  version: 4.11.3
  url: https://kubernetes.github.io/ingress-nginx

subChartRepositories:
  - name: generic-python-frontend
    project: quant-cm
    url: https://raw.githubusercontent.com/miletocarmelo/DEVOPS_HELM_generic_python_frontend/github-pages
  
  #   - name: generic-python-frontend-temp-pod
  #     project: quant-cm
  #     url: https://github.com/MiletoCarmelo/DEVOPS_HELM_generic_python_frontend_temporary_pods_creation/github-pages

apps:

  - name: cert-manager
    namespace: cert-manager
    project: infrastructure
    syncPolicy:               # Ajout ici
      automated:
        prune: true
        selfHeal: true
      syncOptions:
        - CreateNamespace=true
        - PrunePropagationPolicy=foreground
        - PruneLast=true        # supprime les ressources en dernier
        - ApplyOutOfSyncOnly=true  # applique uniquement les ressources désynchronisées
        - Validate=false        # désactive la validation kubernetes
    source:
      chart: cert-manager
      repoURL: https://charts.jetstack.io
      targetRevision: v1.16.1
      helm:
        values: |-
          installCRDs: true
          global:
            leaderElection:
              namespace: cert-manager

  - name: sealed-secrets
    namespace: sealed-secrets
    project: infrastructure
    syncPolicy:               # Ajout ici
      automated:
        prune: true
        selfHeal: true
      syncOptions:
        - CreateNamespace=true
        - PrunePropagationPolicy=foreground
        - PruneLast=true        # supprime les ressources en dernier
        - ApplyOutOfSyncOnly=true  # applique uniquement les ressources désynchronisées
        - Validate=false        # désactive la validation kubernetes
    source:
      chart: sealed-secrets
      repoURL: https://bitnami-labs.github.io/sealed-secrets
      targetRevision: 0.27.2
      helm:
        values: |-
          fullnameOverride: sealed-secrets
          commandArgs:
            - --update-status
            - --allow-namespace-wide
          serviceMonitor:
            enabled: false
          ingress:
            enabled: false
          secretName: "sealed-secrets-key"
  
  - name: ingress-nginx
    namespace: ingress-nginx
    project: infrastructure
    syncPolicy:               # Ajout ici
      automated:
        prune: true
        selfHeal: true
      syncOptions:
        - CreateNamespace=true
        - PrunePropagationPolicy=foreground
        - PruneLast=true        # supprime les ressources en dernier
        - ApplyOutOfSyncOnly=true  # applique uniquement les ressources désynchronisées
        - Validate=false        # désactive la validation kubernetes
    source:
      chart: ingress-nginx
      repoURL: https://kubernetes.github.io/ingress-nginx
      targetRevision: 4.11.3
      helm:
        values: |-
          controller:
            publishService:
              enabled: true
            service:
              type: NodePort
              nodePorts:
                http: 30753
                https: 31098
            metrics:
              enabled: true
            podAnnotations:
              prometheus.io/scrape: "true"
              prometheus.io/port: "10254"


  - name: success-app-dev
    namespace: dev
    project: quant-cm
    syncPolicy:               # Ajout ici
      automated:
        prune: true
        selfHeal: true
      syncOptions:
        - CreateNamespace=true
        - PrunePropagationPolicy=foreground
        - PruneLast=true        # supprime les ressources en dernier
        - ApplyOutOfSyncOnly=true  # applique uniquement les ressources désynchronisées
        - Validate=false        # désactive la validation kubernetes
    source:
      repoURL: https://github.com/MiletoCarmelo/success-app.git
      path: "k8s"
      helm:
        valueFiles: values.dev.yaml
      targetRevision: prod
      
  - name: tsa-dev # ca va setup le releaseName variabe
    namespace: dev
    project: quant-cm
    syncPolicy:               # Ajout ici
      automated:
        prune: true
        selfHeal: true
      syncOptions:
        - CreateNamespace=true
        - PrunePropagationPolicy=foreground
        - PruneLast=true        # supprime les ressources en dernier
        - ApplyOutOfSyncOnly=true  # applique uniquement les ressources désynchronisées
        - Validate=false        # désactive la validation kubernetes
    source:
      repoURL: https://github.com/MiletoCarmelo/DEVOPS_DEPLOY_TradingStrategyAnaylsis.git
      path: umbrella-trading-strategy-analysis
      helm:
        valueFiles: values.dev.yaml
      targetRevision: prod

  # - name: tsa-pod-dev 
  #   namespace: dev
  #   project: quant-cm
  #   source:
  #     repoURL: https://github.com/MiletoCarmelo/DEVOPS_DEPLOY_TradingStrategyAnaylsis.git
  #     path: umbrella-trading-strategy-analysis-temp-pod
  #     helm:
  #       valueFiles: values.dev.yaml
  #     targetRevision: prod

  - name: optionsviz-dev # ca va setup le releaseName variabe
    namespace: dev
    project: quant-cm
    syncPolicy:               # Ajout ici
      automated:
        prune: true
        selfHeal: true
      syncOptions:
        - CreateNamespace=true
        - PrunePropagationPolicy=foreground
        - PruneLast=true        # supprime les ressources en dernier
        - ApplyOutOfSyncOnly=true  # applique uniquement les ressources désynchronisées
        - Validate=false        # désactive la validation kubernetes
    source:
      repoURL: https://github.com/MiletoCarmelo/DEVOPS_DEPLOY_OptionsViz.git
      path: umbrella-optionsviz
      helm:
        valueFiles: values.dev.yaml
      targetRevision: prod
      urlBase: "https://github.com"  # URL base pour GitHub
      credentialsName: github-repo-creds  # Référence au secret générique

  - name: ingress-setup-dev     # Changé pour correspondre au nom attendu
    namespace: dev
    project: quant-cm
    syncPolicy:               # Ajout ici
      automated:
        prune: true
        selfHeal: true
      syncOptions:
        - CreateNamespace=true
        - PrunePropagationPolicy=foreground
        - PruneLast=true        # supprime les ressources en dernier
        - ApplyOutOfSyncOnly=true  # applique uniquement les ressources désynchronisées
        - Validate=false        # désactive la validation kubernetes
    source:
      repoURL: https://github.com/MiletoCarmelo/DEVOPS_HELM_localhost_ingress.git
      path: ingress-setup
      helm:
        valueFiles: values.dev.yaml
      targetRevision: prod
